## <center>打印系统驱动使用</center>

[TOC]

### 一、驱动接口功能说明

```c
static const struct file_operations up_dev_fops = {
	.owner = THIS_MODULE,
	.open = up_dev_open,
	.release = up_dev_release,
	.read = up_dev_read,
};

static struct miscdevice up_dev_device = {
	.minor = MISC_DYNAMIC_MINOR,
	.name = "up_dev",
	.fops = &up_dev_fops,
};

static const struct file_operations down_dev_fops = {
	.owner = THIS_MODULE,
	.open = down_dev_open,
	.release = down_dev_release,
	.write = down_dev_write,
	.read = down_dev_read,
};

static struct miscdevice down_dev_device = {
	.minor = MISC_DYNAMIC_MINOR,
	.name = "down_dev",
	.fops = &down_dev_fops,
};
```

​		以上是应用层调用对应设备文件接口函数调用到的驱动层接口函数。

#### 1. 上行驱动接口功能说明

​		**上行接口是指arm往fpga发数据，fpga从arm读数据使用的接口。**

##### 1.1 up_dev_open

```c
/* 初始化上行驱动数据 */
static int up_dev_open(struct inode *ip, struct file *fp)
{
	...
}
```



##### 1.2 up_dev_read

```c
/* 阻塞直到收到上行dma中断(也可能打印异常或完成),
 * 表示fpga发送完一块数据到hps的dma buf,
 * 然后将hps侧的dma buf中的数据拷贝到应用层user_buffer中,
 * 拷贝的数据量大小为count字节
*/
static ssize_t
up_dev_read(struct file *fp, char __user *user_buffer, size_t count, loff_t *offset)
{
	...
}    
```



##### 1.3 up_dev_release

```c
/* 释放上行驱动数据 */
static int up_dev_release(struct inode *ip, struct file *fp)
{
	...
}
```



#### 2. 下行驱动接口功能说明

​		**下行接口指fpga向arm发数据，arm从fpga读数据使用的接口。**

##### 2.1 down_dev_open

```c
/* 初始化下行驱动数据 */
static int down_dev_open(struct inode *ip, struct file *fp)
{
	...
}
```



##### 2.2 down_dev_read

```c
/* 阻塞直到收到下行dma中断(也可能打印异常或完成),
 * 表示arm发送完一块数据到fpga的dma buf并收到fpga的确认,
 * 然后将可用dma buf信息拷贝到应用层user_buffer中,
*/
static ssize_t
down_dev_read(struct file *fp, char __user *user_buffer, size_t count, loff_t *offset)
{
	...   
}
```



##### 2.3 down_dev_write

```c
/* 将用户user_buffer中的数据写到hps的dma buf */
static ssize_t
down_dev_write(struct file *fp,
		   const char __user *user_buffer, size_t count,
		   loff_t *offset)
{
    ...
}
```



##### 2.4 down_dev_release

```c
/* 释放下行驱动数据 */
static int down_dev_release(struct inode *ip, struct file *fp)
{
	...
}
```



### 二、驱动接口应用层调用方法



### 三、驱动框架




### 四、示例